<!DOCTYPE html>
<html>
  <head>
    <title>Terra Mystica Statistics</title>
    <script type="text/javascript" language="javascript"
            src="/stc/prototype-1.7.1.js">
    </script>
    <script type="text/javascript" language="javascript"
            src="/stc/debug.js">
    </script>
    <script type="text/javascript" language="javascript"
            src="/stc/faction.js">
    </script>
    <link rel="stylesheet" type="text/css" href="/stc/style.css">
  </head>
  <body style="padding: 5ex">
    <div id="header"><div><a href="/" accesskey="h">Home</a></div><div><a href="/usage.html" accesskey="u">Help</a></div><div id="user-info"></div></div>
    <div id="error"></div>
    Statistics computed from <span id="count">?</span> finished games.
    Only games with at least 3 players are included.
    <h3>Faction Statistics</h3>
    <table id="faction-stats" class="building-table"><tr><td>Faction<td>Wins<td>Games<td>Win %<td>Average position<td>Average score<td>Average loss<td>Games Won</table>
    <h3>High Scores</h3>
    <table id="high-scores" class="building-table"><tr><td>Faction<td>3p<td>4p<td>5p</table>
    <h3>Start Position Statistics (3p)</h3>
    <table id="position-stats-3p" class="building-table"><tr><td>Position<td>Wins<td>Games<td>Win %<td>Average position<td>Average score<td>Average loss</table>
    <h3>Start Position Statistics (4p)</h3>
    <table id="position-stats-4p" class="building-table"><tr><td>Position<td>Wins<td>Games<td>Win %<td>Average position<td>Average score<td>Average loss</table>
    <h3>Start Position Statistics (5p)</h3>
    <table id="position-stats-5p" class="building-table"><tr><td>Position<td>Wins<td>Games<td>Win %<td>Average position<td>Average score<td>Average loss</table>
    <div id="timestamp" style="margin-top: 2ex; "></div>
    <script language="javascript">
      var state = null;
      var id = document.location.pathname;

      function showStats() {
         var count = 0;
         $H(state.factions).sortBy(function (a) { return -a.value.win_rate } ).each(function(elem) {
            elem.value.game_links = "";
            (elem.value.games_won || []).each(function (id) {
                elem.value.game_links += ("<a href='/game/" + id + "'>" + id + "</a> ");
            });
            elem.game_link_id_attr = "\"\"".interpolate(elem);

            $("faction-stats").insert("<tr><td>#{key}<td>#{value.wins}<td>#{value.count}<td>#{value.win_rate}<td>#{value.average_position}<td>#{value.average_vp}<td>#{value.average_loss_vp}<td><span id=#{key}-links style='display: none'>#{value.game_links}</span><a href='javascript:showLinks(\"#{key}\")' id=#{key}-show-link>[show]</a></tr>"
               .interpolate(elem));
            count += elem.value.wins;
            $("high-scores").insert("<tr><td>#{key}<td><a href='/game/#{value.high_score.3.game}'>#{value.high_score.3.vp}</a><td><a href='/game/#{value.high_score.4.game}'>#{value.high_score.4.vp}</a><td><a href='/game/#{value.high_score.5.game}'>#{value.high_score.5.vp}</a></tr>"
               .interpolate(elem));
         });
         ["-3p", "-4p", "-5p"].each(function(count) {
            $H(state["positions" + count]).sortBy(function (a) { return -a.value.win_rate } ).each(function(elem) {
                $("position-stats" + count).insert("<tr><td>#{key}<td>#{value.wins}<td>#{value.count}<td>#{value.win_rate}<td>#{value.average_position}<td>#{value.average_vp}<td>#{value.average_loss_vp}</tr>"
                   .interpolate(elem));
            });
         });
         $("timestamp").innerHTML = "Last updated: " + state.timestamp;
         $("count").innerHTML = Math.round(count);
      }

      function showLinks(id) {
          $(id + "-links").style.display = "block";
          $(id + "-show-link").style.display = "none";
      }

      new Ajax.Request("/data/stats.json", {
          method:"get",
          onSuccess: function(transport){
            state = transport.responseText.evalJSON();
            try {
              showStats();
            } catch (e) {
              handleException(e);
            };
          }
      });
    </script>
  </body>
</html>
