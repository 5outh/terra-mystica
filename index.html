<html>
  <head>
    <title>Terra Mystica</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <script type="text/javascript" language="javascript"
            src="/stc/prototype-1.7.1.js">
    </script>
    <link rel="stylesheet" type="text/css" href="/stc/style.css">
  </head>
  <body style="padding: 5ex">
    <div style="float: right; height: 200px">
      <script>
        if (!/session-username=(.+)/.match(document.cookie)) {
          document.write('<a href="/login/">Login</a><br>');
          document.write('<a href="/register/">Register</a><br>');
        } else {
          document.write('<a href="/newgame/">New Game</a><br>');
          document.write('<a href="/logout/">Logout</a><br>');
        }
      </script>
    </div>

    <p>
    This is an unofficial automated moderator tool
    for <a href="http://www.terra-mystica-spiel.de/en/index.php">Terra
    Mystica</a>, a game by Helge Ostertag and Jens Dr&ouml;gem&uuml;ller
    published by Feuerland Spiele.
    </p>

    <p>
    See the <a href="http://terra.snellman.net/usage.html">instructions</a>
    for more information on using the moderator. For information on rules,
    please refer to the original manual.
    </p>

    <h4>Your Active Games</h4>
    <table id="yourgames-active" class="gamelist"></table>

    <h4>Your Finished Games</h4>
    <table id="yourgames-finished" class="gamelist"><tr><td><a href="javascript:fetchGames('yourgames-finished', 'user', 'finished', listGames)">Load</a></table>

    <h4>All Games</h4>
    <table id="allgames" class="gamelist"><tr><td><a href="javascript:fetchGames('allgames', 'all', '', listGames)">Load</a></table>

    <script language="javascript">
      var state = null;
      var id = document.location.pathname;

      function listGames(div, mode, status) {
         $(div).innerHTML = "";
         state.games.each(function(elem) {
            elem.status = "";
            if (elem.finished) { elem.status = "game-status-finished"; }
            if (elem.action_required) { elem.status = "game-status-action-required"; }
            if (elem.seconds_since_update) {
               var amount;
               var unit;
               if (elem.seconds_since_update > 86400) {
                   amount = Math.round(elem.seconds_since_update / 86400);
                   unit = "day";
               } else if (elem.seconds_since_update > 3600) {
                   amount = Math.round(elem.seconds_since_update / 3600);
                   unit = "hour";
               } else if (elem.seconds_since_update > 60) {
                   amount = Math.round(elem.seconds_since_update / 60);
                   unit = "minute";
               } else {
                   amount = Math.round(elem.seconds_since_update);
                   unit = "second";
               }
               if (amount > 1) { unit += "s" }
               elem.time_since_update = "last move " + amount + " " + unit + " ago";
            }
            $(div).insert("<tr class='#{status}'><td>#{id}<td><a href='#{link}'> #{role}<td>#{time_since_update}</a></tr>"
               .interpolate(elem));
         });
         if (mode == "user") {
           var link = new Element('a', {"href": "#", "accesskey": "n"}).update("Refresh");
           link.onclick = function() { fetchGames(div, mode, status, nextGame); } 
           var td = new Element('td').insert(link);
           var tr = new Element('tr').insert(new Element("td")).insert(td);
           $(div).insert(tr);
         }
      }

      function nextGame(div, mode, status) {
         state.games.each(function(elem) {
            if (elem.action_required) { document.location = elem.link; }
         });
         listGames(div, mode, status);
      }

      function fetchGames(div, mode, status, handler) {
          $(div).innerHTML = "... loading";
          new Ajax.Request("/cgi-bin/gamelist.pl", {
              parameters: { "mode": mode, "status": status },
              method:"get",
              onSuccess: function(transport){
                state = transport.responseText.evalJSON();
                try {
                  if (!state.error) {
                    handler(div, mode, status);
                  } else {
                    $(div).innerHTML = "<tr><td>" + state.error + "</td>";
                  }
                } catch (e) {
                  handleException(e);
                };
              }
          });
      }

      fetchGames("yourgames-active", "user", "running", listGames);
    </script>
  </body>
</html>
